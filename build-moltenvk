#!/bin/bash -e
#
# MoltenVK
# https://github.com/KhronosGroup/MoltenVK.git
#
cd "$(dirname "$0")"
set -a; . .env; set +a

pkgname="moltenvk"
pkgdir="${STOWDIR}/${pkgname}"
srcdir="src/MoltenVK"
builddir="${TMPDIR:-/tmp}/build.${pkgname}"
icddir="${pkgdir}/etc/vulkan/icd.d"

echo
echo "*** $0: started"

rm -rf "${builddir}"

cmake -B "${builddir}" -S "${srcdir}" \
  -DCMAKE_INSTALL_PREFIX="${pkgdir}" \
  -DCMAKE_INSTALL_NAME_DIR="${pkgdir}/lib" \
  -DCMAKE_BUILD_TYPE=Release \
  -DCMAKE_INTERPROCEDURAL_OPTIMIZATION=ON \
  -DMVK_CONFIG_LOG_LEVEL=error \
  -DCPM_SOURCE_CACHE=src/CPM \
  -Wno-dev \
  "$@"

cmake --build "${builddir}"

rm -rf "${pkgdir}"

cmake --install "${builddir}"
install -d "${icddir}"
install -vm644 "${srcdir}"/MoltenVK/icd/MoltenVK_icd.json "${icddir}"
sed -i '' "s;\./;${pkgdir}/lib/;" "${icddir}"/MoltenVK_icd.json
rm -rf "${pkgdir}"/{bin,share}
stow -Rd "${STOWDIR}" "${pkgname}"

echo
echo 'MoltenVK_icd.json:'
cat "${icddir}"/MoltenVK_icd.json
echo

rm -rf "${builddir}"

echo "*** $0: finished"
